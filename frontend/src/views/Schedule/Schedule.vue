<script setup lang="ts">
import { ref, onMounted } from 'vue';
import FullCalendar from '@fullcalendar/vue3';
import dayGridPlugin from '@fullcalendar/daygrid';
import timeGridPlugin from '@fullcalendar/timegrid';
import interactionPlugin from '@fullcalendar/interaction';
import { createEventId } from './event-utils';
import moment from 'moment';
import axios from 'axios';
import EditEventModal from './EditEventModal.vue';
import MaintenanceModal from './MaintenanceModal.vue';

const isMaintenanceModalVisible = ref(false);
const isEditEventModalVisible = ref(false);

const maintenance = ref({
  id: '',
  title: '',
  description: '',
  color: '',
  startedAt: moment().format('YYYY-MM-DD'),
  endedAt: moment().format('YYYY-MM-DD'),
});

const calendarRef = ref(null);
const currentEvents = ref([]);

// Maintenance modal 열기
function openMaintenanceModal(startDate, endDate) {
  maintenance.value = {
    id: '',
    title: '',
    description: '',
    color: '',
    startedAt: startDate,
    endedAt: endDate,
  };
  isMaintenanceModalVisible.value = true;
}

// 새 이벤트 추가
function addEvent(eventData) {
  const colorWithoutHash = eventData.color.replace('#', '');

  const scheduleData = {
    userNo: 1,
    beginDate: eventData.startedAt,
    endDate: moment(eventData.endedAt).add(1, 'days').format('YYYY-MM-DD'),
    title: eventData.title,
    todo: eventData.description,
    color: colorWithoutHash || '000000',
  };

  axios
    .post('/api/schedule/add', scheduleData)
    .then(async (response) => {
      if (response && response.data) {
        // 일정 추가 후 모든 일정을 다시 로딩
        await loadEvents();
      }
      closeMaintenanceModal();
    })
    .catch((error) => {
      console.error('일정 추가 중 오류 발생:', error);
    });
}

function handleEventClick(clickInfo) {
  const event = clickInfo.event;

  maintenance.value = {
    id: event.id || '', // id가 null 또는 undefined일 경우 빈 문자열을 사용
    title: event.title || '',
    description: event.extendedProps.description || '',
    color: event.backgroundColor || '000000',
    startedAt: event.start
      ? moment(event.start).format('YYYY-MM-DD') // 날짜만 표시
      : '',
    endedAt: event.end ? moment(event.end).format('YYYY-MM-DD') : '', // 날짜만 표시
  };

  console.log(
    'Clicked Event Details:',
    JSON.stringify(maintenance.value, null, 2)
  );
  // 데이터 확인
  isEditEventModalVisible.value = true; // 모달 표시
}

// 기존 이벤트 업데이트
function updateEvent(updatedEvent) {
  const colorWithoutHash = updatedEvent.color.replace('#', ''); // 색깔 Hex코드 저장
  console.log('Updated Event Data:', updatedEvent); // updatedEvent 객체 확인

  const scheduleData = {
    id: event.eventNo,
    title: updatedEvent.title,
    todo: updatedEvent.description || '',
    beginDate: updatedEvent.startedAt || moment().format('YYYY-MM-DD'),
    endDate: updatedEvent.endedAt || moment().format('YYYY-MM-DD'),
    color: colorWithoutHash || '000000',
    // backgroundColor: `#${createdEvent.color}`, // 색상 속성 수정
    // borderColor: `#${createdEvent.color}`, // 색상 속성 추가
  };

  axios
    .post(`/api/schedule/update/${updatedEvent.id}`, scheduleData)
    .then((response) => {
      const calendarApi = calendarRef.value?.getApi();
      if (calendarApi) {
        const event = calendarApi.getEventById(updatedEvent.id);
        if (event) {
          event.setProp('title', updatedEvent.title);
          event.setStart(updatedEvent.startedAt);
          event.setEnd(updatedEvent.endedAt);
          event.setProp('backgroundColor', `#${colorWithoutHash}`);
          event.setProp('borderColor', `#${colorWithoutHash}`);
          event.setExtendedProp('description', updatedEvent.description);
        }
      }
      closeEditEventModal();
    })
    .catch((error) => {
      console.error('Error updating event:', error);
    });
}
// 모달 닫기 함수
function closeMaintenanceModal() {
  isMaintenanceModalVisible.value = false;
}
function closeEditEventModal() {
  isEditEventModalVisible.value = false;
}

// Date selection handler
function handleDateSelect(selectInfo) {
  const startDate = selectInfo.startStr;
  const endDate = selectInfo.endStr || startDate;
  openMaintenanceModal(startDate, endDate);
}

// Load events from the backend
async function loadEvents() {
  try {
    const response = await axios.get('/api/schedule/list');
    const events = response.data;
    const calendarApi = calendarRef.value.getApi();

    // 기존 모든 이벤트 제거
    calendarApi.removeAllEvents();

    events.forEach((event) => {
      calendarApi.addEvent({
        id: event.eventNo,
        title: event.title,
        start: event.beginDate,
        end: event.endDate,
        backgroundColor: `#${event.color}`,
        borderColor: `#${event.color}`,
        allDay: true,
        extendedProps: {
          description: event.todo,
        },
      });
    });
  } catch (error) {
    console.error('이벤트 로딩 중 오류 발생:', error);
  }
}

onMounted(() => {
  loadEvents();
});

// 삭제
function deleteEvent(eventId) {
  axios
    .delete(`/api/schedule/delete/${eventId}`)
    .then((response) => {
      console.log('Event deleted successfully:', response.data);
      // 캘린더에서 삭제된 이벤트 제거
      const calendarApi = calendarRef.value.getApi();
      const event = calendarApi.getEventById(eventId);
      if (event) {
        event.remove();
      }
      closeEditEventModal();
    })
    .catch((error) => {
      console.error('Error deleting event:', error);
    });
}
const calendarOptions = ref({
  plugins: [dayGridPlugin, timeGridPlugin, interactionPlugin],
  headerToolbar: {
    left: 'prev,next today',
    center: 'title',
    right: 'dayGridMonth,timeGridWeek,timeGridDay',
  },
  initialView: 'dayGridMonth',
  editable: true,
  selectable: true,
  dayMaxEvents: true,
  weekends: true,
  select: handleDateSelect,
  eventClick: handleEventClick,
  eventsSet: (events) => (currentEvents.value = events),
});
</script>

<template>
  <div class="container-fluid" style="width: 85%" id="responsive-container">
    <div class="card card-body demo-app d-flex flex-column flex-md-row">
      <div class="demo-app-main col-md-9">
        <FullCalendar
          ref="calendarRef"
          class="demo-app-calendar"
          :options="calendarOptions"
        >
          <template v-slot:eventContent="arg">
            <b>{{ arg.timeText }}</b>
            <i>{{ arg.event.title }}</i>
          </template>
        </FullCalendar>
      </div>
      <div class="demo-app-sidebar demo-app-sidebar-section col-md-3">
        <h5>이번 달 이벤트 ({{ currentEvents.length }})</h5>
        <ul>
          <li v-for="event in currentEvents" :key="event.id">
            <b>{{ event.startStr }}</b>
            <i>{{ event.title }}</i>
          </li>
        </ul>
      </div>
    </div>
  </div>
  <MaintenanceModal
    v-if="isMaintenanceModalVisible"
    :isVisible="isMaintenanceModalVisible"
    :maintenance="maintenance"
    @closeModal="closeMaintenanceModal"
    @saveEvent="addEvent"
  />
  <EditEventModal
    v-if="isEditEventModalVisible"
    :isVisible="isEditEventModalVisible"
    :maintenance="maintenance"
    @closeModal="closeEditEventModal"
    @deleteEvent="deleteEvent"
    @saveEvent="updateEvent"
  />
</template>

<style lang="css">
.modal {
  background-color: rgba(0, 0, 0, 0.5);
}
.modal-footer {
  display: flex;
  justify-content: space-between;
}
h2 {
  margin: 0;
  font-size: 16px;
}
ul {
  margin: 0;
  padding-left: 1rem !important;
  padding: 0 0 0 1.5em;
}
b {
  margin-right: 3px;
}
.demo-app {
  display: flex;
  min-height: 100%;
  font-family:
    Arial,
    Helvetica Neue,
    Helvetica,
    sans-serif;
  font-size: 14px;
  background: #fff6ef !important;
}
.demo-app-sidebar {
  line-height: 1.5;
  background: #fdf4bb !important;
  border-right: 2px solid #ffeb69 !important;
  border-radius: 1rem;
}
.demo-app-sidebar-section {
  padding: 1em;
  margin-top: 1rem;
}
.demo-app-main {
  flex-grow: 1;
  padding: 1em;
}
.fc {
  max-width: 1100px;
  margin: 0 auto;
}
.fc-toolbar .fc-button {
  background-color: #ffeb69 !important;
  color: white;
  border: 0px !important;
}
.fc-toolbar .fc-button:hover {
  background-color: #ffeb69 !important;
  color: black !important;
}
.fc-day-sun a,
.fc-day-sat a {
  color: rgb(253, 150, 150) !important;
}
.fc .fc-toolbar.fc-header-toolbar {
  margin-bottom: 1.5em !important;
  background: #fdf4bb !important;
  padding: 1rem !important;
  border-radius: 1rem !important;
}
.color-picker-btn {
  border: none;
  cursor: pointer;
}
.color-picker-btn:focus {
  outline: none;
}
</style>
